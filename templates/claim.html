<!-- templates/claim.html - WITH PROOF OF OWNERSHIP -->
{% extends "base.html" %}

{% block title %}File Claim - Lost & Found{% endblock %}

{% block content %}
<div class="card">
    <h2 style="color: #2c3e50; margin-bottom: 30px;">
        <i class="fas fa-file-contract"></i> File Claim for Item
    </h2>
    <p style="color: #666; margin-bottom: 30px;">Submit a claim with cryptographic proof of ownership.</p>
    
    <!-- Item Details -->
    <div style="background: #f8f9fa; padding: 25px; border-radius: 10px; margin-bottom: 30px;">
        <h4 style="color: #2c3e50; margin-bottom: 20px;">
            <i class="fas fa-box"></i> Item Details
        </h4>
        
        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px; flex-wrap: wrap; gap: 15px;">
            <h3>{{ item.title }}</h3>
            <span style="padding: 8px 15px; border-radius: 15px; 
                  {% if item.item_type == 'lost' %}background: #ffeaa7; color: #856404;{% else %}background: #d4edda; color: #155724;{% endif %}">
                <i class="fas fa-{% if item.item_type == 'lost' %}exclamation-triangle{% else %}search{% endif %}"></i>
                {{ item.item_type|title }} Item
            </span>
        </div>
        
        {% if item.photo_path %}
        <div style="text-align: center; margin: 20px 0;">
            <img src="{{ url_for('serve_upload', filename=item.photo_path) }}" 
                 alt="{{ item.title }}"
                 style="max-width: 100%; max-height: 300px; border-radius: 10px;">
        </div>
        {% endif %}
        
        <p style="color: #666; margin-bottom: 15px;">
            <strong>Description:</strong> {{ item.description }}
        </p>
        
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; color: #666;">
            <div>
                <i class="fas fa-map-marker-alt"></i> {{ item.location }}
            </div>
            <div>
                <i class="fas fa-folder"></i> {{ item.category|title }}
            </div>
            <div>
                <i class="fas fa-calendar"></i> Posted: {{ item.created_at.split()[0] if item.created_at else 'Recently' }}
            </div>
        </div>
    </div>
    
    <!-- Cryptographic Proof of Ownership -->
    <div class="card" style="background: #f0f8ff; border-left: 4px solid #3498db;">
        <h3 style="color: #2c3e50; margin-bottom: 25px;">
            <i class="fas fa-key"></i> Cryptographic Proof of Ownership
        </h3>
        
        <div style="background: #e8f4f8; padding: 20px; border-radius: 8px; margin-bottom: 25px;">
            <h4 style="color: #0c5460; margin-bottom: 15px;">
                <i class="fas fa-shield-alt"></i> Why Cryptographic Proof?
            </h4>
            <p style="color: #0c5460;">
                To prevent fraudulent claims, you must provide cryptographic proof that you are the rightful owner.
                This proof will be digitally signed and verified by both the finder and system administrators.
            </p>
        </div>
        
        <form method="POST" id="claimForm">
            <!-- Claim Message -->
            <div class="form-group">
                <label for="claim_message">
                    <i class="fas fa-comment-dots"></i> Why do you think this is your item? *
                </label>
                <textarea id="claim_message" name="claim_message" rows="6" required
                          placeholder="Please provide detailed information to prove this item belongs to you..."></textarea>
                <p class="help-text">The more details you provide, the easier it is to verify your claim.</p>
            </div>
            
            <!-- Verification Level -->
            <div class="form-group">
                <label for="verification_level">
                    <i class="fas fa-shield-alt"></i> Verification Level *
                </label>
                <select id="verification_level" name="verification_level" required onchange="updateProofRequirements()">
                    <option value="">Select Verification Level</option>
                    <option value="basic">Basic - Claim with description only</option>
                    <option value="enhanced">Enhanced - With supporting evidence</option>
                    <option value="premium">Premium - With cryptographic proof</option>
                </select>
                <p class="help-text">Higher verification levels increase your chances of approval but require more evidence.</p>
            </div>
            
            <!-- Proof of Ownership Evidence -->
            <div id="proofSection" style="display: none;">
                <h4 style="color: #2c3e50; margin: 30px 0 20px 0;">
                    <i class="fas fa-fingerprint"></i> Ownership Evidence
                </h4>
                
                <div class="form-group">
                    <label for="serial_number">
                        <i class="fas fa-barcode"></i> Serial Number / Unique Identifier
                    </label>
                    <input type="text" id="serial_number" name="serial_number" 
                           placeholder="If applicable (e.g., IMEI, serial number)">
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 25px;">
                    <div class="form-group">
                        <label for="purchase_date">
                            <i class="fas fa-calendar"></i> Purchase Date
                        </label>
                        <input type="date" id="purchase_date" name="purchase_date">
                    </div>
                    
                    <div class="form-group">
                        <label for="purchase_location">
                            <i class="fas fa-store"></i> Purchase Location
                        </label>
                        <input type="text" id="purchase_location" name="purchase_location" 
                               placeholder="Where did you buy it?">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="unique_features">
                        <i class="fas fa-star"></i> Unique Features / Damage
                    </label>
                    <textarea id="unique_features" name="unique_features" rows="3"
                              placeholder="Describe any unique features, scratches, damages, or modifications..."></textarea>
                </div>
                
                <div class="form-group">
                    <label for="detailed_description">
                        <i class="fas fa-align-left"></i> Detailed Description
                    </label>
                    <textarea id="detailed_description" name="detailed_description" rows="4"
                              placeholder="Provide extremely detailed description only the true owner would know..."></textarea>
                    <p class="help-text">Include specific measurements, colors, textures, weights, sounds, smells, etc.</p>
                </div>
                
                <div class="form-group">
                    <label for="photo_evidence">
                        <i class="fas fa-camera"></i> Photo Evidence Description
                    </label>
                    <textarea id="photo_evidence" name="photo_evidence" rows="3"
                              placeholder="Describe any photos you have (receipts, you with the item, etc.)..."></textarea>
                </div>
            </div>
            
            <!-- Cryptographic Commitment -->
            <div style="background: #fff3cd; padding: 20px; border-radius: 8px; margin: 25px 0; border-left: 4px solid #f39c12;">
                <h5 style="color: #856404; margin-bottom: 15px;">
                    <i class="fas fa-gavel"></i> Legal & Cryptographic Commitment
                </h5>
                <div style="display: flex; align-items: flex-start; gap: 10px; margin-bottom: 15px;">
                    <input type="checkbox" id="legal_agree" name="legal_agree" required>
                    <label for="legal_agree" style="color: #856404; cursor: pointer;">
                        I certify that all information provided is true and accurate. 
                        False claims may result in legal action and permanent ban.
                    </label>
                </div>
                <div style="display: flex; align-items: flex-start; gap: 10px;">
                    <input type="checkbox" id="crypto_agree" name="crypto_agree" required>
                    <label for="crypto_agree" style="color: #856404; cursor: pointer;">
                        I understand that my claim will be cryptographically signed and verified. 
                        This digital signature serves as legal proof of my claim.
                    </label>
                </div>
            </div>
            
            <!-- Proof Score Preview -->
            <div id="proofScore" style="display: none; background: #e8f4f8; padding: 20px; border-radius: 8px; margin-bottom: 25px;">
                <h5 style="color: #0c5460; margin-bottom: 15px;">
                    <i class="fas fa-chart-line"></i> Proof Strength Preview
                </h5>
                <div id="scoreDisplay" style="text-align: center;">
                    <!-- Score will be calculated dynamically -->
                </div>
            </div>
            
            <div style="text-align: center; margin-top: 30px;">
                <button type="submit" class="btn btn-primary btn-large">
                    <i class="fas fa-paper-plane"></i> Submit Cryptographic Claim
                </button>
                <a href="{{ url_for('browse_items') }}" class="btn btn-secondary" style="margin-left: 15px;">
                    <i class="fas fa-times"></i> Cancel
                </a>
            </div>
        </form>
    </div>
    
    <!-- Security Information -->
    <div class="card" style="border-left: 4px solid #27ae60;">
        <h4 style="color: #2c3e50; margin-bottom: 15px;">
            <i class="fas fa-lock"></i> How Cryptographic Proof Works
        </h4>
        <ol style="color: #666; padding-left: 20px;">
            <li><strong>Digital Signature:</strong> Your claim is cryptographically signed using HMAC-SHA256</li>
            <li><strong>Proof Generation:</strong> Ownership evidence is bundled into a proof token</li>
            <li><strong>Timestamping:</strong> All proofs include cryptographic timestamps</li>
            <li><strong>Finder Verification:</strong> The person who found the item reviews your proof</li>
            <li><strong>Admin Verification:</strong> System administrators cryptographically verify all evidence</li>
            <li><strong>Secure Transfer:</strong> If verified, secure connection is established</li>
        </ol>
    </div>
</div>

<script>
    function updateProofRequirements() {
        const level = document.getElementById('verification_level').value;
        const proofSection = document.getElementById('proofSection');
        const proofScore = document.getElementById('proofScore');
        
        if (level === 'premium') {
            proofSection.style.display = 'block';
            proofScore.style.display = 'block';
            calculateProofScore();
        } else if (level === 'enhanced') {
            proofSection.style.display = 'block';
            proofScore.style.display = 'none';
        } else {
            proofSection.style.display = 'none';
            proofScore.style.display = 'none';
        }
    }
    
    function calculateProofScore() {
        let score = 0;
        const maxScore = 100;
        
        // Base score for claim message
        const claimMessage = document.getElementById('claim_message').value;
        if (claimMessage.length >= 50) score += 10;
        else if (claimMessage.length >= 20) score += 5;
        
        // Serial number (20 points)
        const serialNumber = document.getElementById('serial_number').value;
        if (serialNumber.length >= 6) score += 20;
        
        // Purchase info (15 points)
        const purchaseDate = document.getElementById('purchase_date').value;
        const purchaseLocation = document.getElementById('purchase_location').value;
        if (purchaseDate && purchaseLocation) score += 15;
        else if (purchaseDate || purchaseLocation) score += 5;
        
        // Unique features (15 points)
        const uniqueFeatures = document.getElementById('unique_features').value;
        if (uniqueFeatures.length >= 30) score += 15;
        else if (uniqueFeatures.length >= 10) score += 5;
        
        // Detailed description (25 points)
        const detailedDesc = document.getElementById('detailed_description').value;
        if (detailedDesc.length >= 100) score += 25;
        else if (detailedDesc.length >= 50) score += 15;
        else if (detailedDesc.length >= 20) score += 5;
        
        // Photo evidence (15 points)
        const photoEvidence = document.getElementById('photo_evidence').value;
        if (photoEvidence.length >= 20) score += 15;
        else if (photoEvidence.length >= 10) score += 5;
        
        // Display score
        const scoreDisplay = document.getElementById('scoreDisplay');
        const scorePercent = Math.min(score, maxScore);
        
        let color, message;
        if (scorePercent >= 80) {
            color = '#27ae60';
            message = 'üéâ Excellent proof! High likelihood of verification.';
        } else if (scorePercent >= 60) {
            color = '#f39c12';
            message = 'üëç Good proof. May require additional verification.';
        } else if (scorePercent >= 40) {
            color = '#e67e22';
            message = '‚ö†Ô∏è Fair proof. Consider adding more evidence.';
        } else {
            color = '#e74c3c';
            message = '‚ùå Weak proof. Unlikely to be verified.';
        }
        
        scoreDisplay.innerHTML = `
            <div style="font-size: 2.5rem; font-weight: bold; color: ${color}; margin-bottom: 10px;">
                ${scorePercent}%
            </div>
            <div style="color: ${color}; margin-bottom: 15px;">
                ${message}
            </div>
            <div style="width: 100%; height: 10px; background: #eee; border-radius: 5px; overflow: hidden;">
                <div style="width: ${scorePercent}%; height: 100%; background: ${color};"></div>
            </div>
        `;
    }
    
    // Calculate score as user types
    document.querySelectorAll('#proofSection input, #proofSection textarea').forEach(element => {
        element.addEventListener('input', calculateProofScore);
    });
    
    document.getElementById('claim_message').addEventListener('input', calculateProofScore);
    
    // Form validation
    document.getElementById('claimForm').addEventListener('submit', function(e) {
        const level = document.getElementById('verification_level').value;
        const claimMessage = document.getElementById('claim_message').value;
        
        // Basic validation
        if (claimMessage.length < 10) {
            e.preventDefault();
            alert('Please provide a detailed claim message (at least 10 characters).');
            return false;
        }
        
        // Premium level requires stronger proof
        if (level === 'premium') {
            const detailedDesc = document.getElementById('detailed_description').value;
            if (detailedDesc.length < 50) {
                e.preventDefault();
                alert('Premium verification requires detailed description (at least 50 characters).');
                return false;
            }
        }
        
        // Legal agreements
        if (!document.getElementById('legal_agree').checked || 
            !document.getElementById('crypto_agree').checked) {
            e.preventDefault();
            alert('You must agree to the legal and cryptographic terms.');
            return false;
        }
        
        // Final confirmation
        const confirmed = confirm(
            'Are you ready to submit your cryptographic claim?\n\n' +
            '‚úì Your claim will be digitally signed\n' +
            '‚úì Proof of ownership will be verified\n' +
            '‚úì False claims may have legal consequences\n\n' +
            'Click OK to submit your cryptographic claim.'
        );
        
        if (!confirmed) {
            e.preventDefault();
            return false;
        }
        
        return true;
    });
    
    // Initialize
    updateProofRequirements();
</script>
{% endblock %}